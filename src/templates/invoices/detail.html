{% extends "base.html" %}
{% load static %}
{% block title %}IDEAL_ASP{% endblock %}
{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/constructions/detail.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/invoices/detail.css' %}">
{% endblock %}

{% load parse %}
{% load humanize %}

{% block content %}
<div class="wrapper">
    <div id="sideBar_wrapper" class="sideBar">
        {% include "side-bar.html" %}
    </div>
    <div class="row">
        <main class="col-md-12">
            <div class="p-6">
                {% include "documents-tab.html" %}
                <div class="tab-content">
                        <div id="tab_quote" class="tab-pane active">
                            <form id="update-form" method="post">
                                {% csrf_token %}
                            <div id="_message-box" class="{{ alert_type }}">{{ alert_message }}</div>
                            <div id="">
                                <div class="wrapper_button">
                                    <a href="{% url 'invoices:search' %}"><button type="button" class="btn-back btn btn-outline-warning btn-md" value="q"><i class="sub-icon fas fa-angle-double-left"></i>戻る</button></a>
                                    <button type="submit" class="btn-update btn btn-outline-warning btn-md _invoice-save-button" form="update-form" formaction="{% url 'invoices:update' invoice.id %}" formmethod="post"><i class="sub-icon fas fa-file-export"></i>保存</button>
                                    <button type="submit" class="btn btn-outline-warning btn-md _invoice-preview-btn" form="update-form" formaction="{% url 'invoices:preview' invoice.id %}" formmethod="post"><i class="sub-icon fas fa-search-plus"></i>プレビュー</button>
                                    <button class="btn btn_delete btn-outline-warning btn-md"><a href="{% url 'invoices:delete' invoice.id %}" class="_invoice-delete-btn"><i class="sub-icon fas fa-trash-alt"></i>削除</a></button>
                                </div>
                                <div class="row">
                                    <div class="col-7">
                                        <div class="form_area">
                                            <div class="row">
                                                <div class="col-md-12 col-lg-6">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-bordered text-nowrap">
                                                            <tbody>
                                                                <tr>
                                                                    <th>請求先顧客名</th>
                                                                    <td><input type="text" class="form-control" name="client_name" value="{{ invoice.client_name }}"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>契約者名</th>
                                                                    <td>
                                                                        <input type="text" class="form-control" name="contractor_name" value="{{ invoice.contractor_name }}">
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-bordered text-nowrap">
                                                            <tbody>
                                                                <tr>
                                                                    <th>支払い期日</th>
                                                                    <td><input type="date" class="form-control" name="payment_date" value="{{ invoice.payment_date|date:'Y-m-d'  }}" disabled></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>振込先</th>
                                                                    <td><input type="text" class="form-control" name="bank_account" value="{{ invoice.bank_account }}"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>請求書発行日</th>
                                                                    <td><input type="date" class="form-control" name="published_date" value="{{ invoice.published_date|date:'Y-m-d' }}"></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>請求書番号</th>
                                                                    <td>{{ invoice.code }}</td>
                                                                </tr>
                                                                <tr>
                                                                    <th>入金確認日</th>
                                                                    <td><input type="date" class="form-control" name="comfirm_date" value="{{ invoice.comfirm_date|date:'Y-m-d' }}"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="table-responsive col-md-12 col-lg-6">
                                                    <table class="table table-striped table-bordered text-nowrap">
                                                        <tbody>
                                                            <tr>
                                                                <th>工事番号</th>
                                                                <td>{{ invoice.construction.code }}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>工事件名</th>
                                                                <td><input type="text" class="form-control" name="construction_name" value="{{ invoice.construction_name }}"></td>
                                                            </tr>
                                                            <tr>
                                                                <th>請求者</th>
                                                                <td>
                                                                    <select class="form-control" name="billing_user_name" value="{{ invoice.billing_user_name }}">
                                                                    {% for user in users %}
                                                                        {% if user.name == invoice.billing_user_name %}
                                                                            <option value="{{ user.name }}" selected>{{ user.name }}</option>
                                                                        {% else %}
                                                                            <option value="{{ user.name }}">{{ user.name }}</option>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    </select>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>営業担当</th>
                                                                <td>
                                                                    <select class="form-control" name="sales_user_name" value="{{ invoice.sales_user_name }}">
                                                                    {% for user in users %}
                                                                        {% if user.name == invoice.sales_user_name %}
                                                                            <option value="{{ user.name }}" selected>{{ user.name }}</option>
                                                                        {% else %}
                                                                            <option value="{{ user.name }}">{{ user.name }}</option>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>送付区分</th>
                                                                <td>
                                                                    {% for delivery_method in delivery_methods %}
                                                                        <div class="form-check form-check-inline">
                                                                            {% if delivery_method.0|str == invoice.delivery_method|str %}
                                                                                <input class="form-check-input" type="radio" name="delivery_method" value="{{ delivery_method.0 }}" checked>
                                                                                <label class="form-check-label">{{ delivery_method.1 }}</label>
                                                                            {% else %}
                                                                                <input class="form-check-input" type="radio" name="delivery_method" value="{{ delivery_method.0 }}">
                                                                                <label class="form-check-label">{{ delivery_method.1 }}</label>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>請求区分</th>
                                                                <td>
                                                                    {% for billing_type in billing_types %}
                                                                        <div class="form-check form-check-inline">
                                                                            {% if billing_type.0|str == invoice.billing_type|str %}
                                                                                <input class="form-check-input" type="radio" name="billing_type" value="{{ billing_type.0 }}" checked>
                                                                                <label class="form-check-label">{{ billing_type.1 }}</label>
                                                                            {% else %}
                                                                                <input class="form-check-input" type="radio" name="billing_type" value="{{ billing_type.0 }}">
                                                                                <label class="form-check-label">{{ billing_type.1 }}</label>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% endfor %}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-5">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>作成者</th>
                                                        <th>作成日</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>{{ invoice.created.name }}</td>
                                                        <td>{{ invoice.created_at }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>修正者</th>
                                                        <th>修正日</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        {% if invoice.updated_at %}
                                                            <td>{{ invoice.updated.name }}</td>
                                                            <td>{{ invoice.updated_at }}</td>
                                                        {% endif %}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <tbody>
                                                    <tr>
                                                        <th>御契約金額</th>
                                                        <td><input type="number" class="form-control" name="contract_total" value="{{ invoice.contract_total }}"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>既入金額</th>
                                                        <td><input type="number" class="form-control" disabled value="{{ invoice_balance.existing_amount }}"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>今回請求金額</th>
                                                        <td><input type="number" class="form-control" name="billing_total" id="billing_total" value="{{ invoice.billing_total }}"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>未請求金額</th>
                                                        <td><input type="number" class="form-control" disabled value="{{ invoice_balance.unbilled_amount }}"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>残金</th>
                                                        <td><input type="number" class="form-control" name="balance_total" value="{{ invoice.balance_total }}"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>小計</th>
                                                        <th>消費税</th>
                                                        <th>合計(税込)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><i id='invoice_total'>{{ invoice.total | intcomma }}</i> 円</td>
                                                        <td><i id='invoice_tax'>{{ invoice.tax | intcomma }}</i> 円</td>
                                                        <td><i id='invoice_total_with_tax'>{{ invoice.total_with_tax | intcomma }}</i> 円</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>見積番号</th>
                                                    <th>現場名</th>
                                                    <th>数量</th>
                                                    <th>金額(税抜)</th>
                                                    <th>削除</th>
                                                </tr>
                                            </thead>
                                            <tbody id="add-row-target">
                                                <input type="hidden" id="tax_rate" name="tax_rate" value="{{ tax_rate }}">
                                                {% for invoice_detail in invoice_details %}
                                                <tr>
                                                  <input type="hidden" name="invoice_detail_ids[]" value="{{ invoice_detail.id }}">
                                                  <input type="hidden" name="delete_flgs[]" value="false">
                                                  <td>
                                                    <select class="form-control _estimation-code-pd" name="estimation_codes[]" value="{{ invoice_detail.estimation_code }}">
                                                      {% for estimation in estimations %}
                                                        {% if  invoice_detail.estimation_code == estimation.code %}
                                                          <option value="{{ estimation.code }}" selected>{{ estimation.code }}</option>
                                                        {% else %}
                                                          <option value="{{ estimation.code }}">{{ estimation.code }}</option>
                                                        {% endif %}
                                                      {% endfor %}
                                                    </select>
                                                  </td>
                                                  <td><input type="text" class="form-control" name="project_types[]" id="" value="{{ invoice_detail.project_type }}"></td>
                                                  <td><input type="text" class="form-control" name="quantities[]" id="" value="{{ invoice_detail.quantity }}"></td>
                                                  <td><input type="number" class="form-control _prices" name="prices[]" id="" value="{{ invoice_detail.price }}"></td>
                                                  <td><button type="button" class="btn btn-outline-warning btn-md _delete-detail-btn"><i class="sub-icon fas fa-trash-alt"></i>削除</button></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tr class="_hidden-row _add-invoice-detail">
                                                <input type="hidden" name="invoice_detail_ids[]" value="">
                                                <input type="hidden" name="delete_flgs[]" value="false">
                                                <td>
                                                    <select class="form-control _estimation-code-pd" name="estimation_codes[]" value="">
                                                      <option disabled selected></option>
                                                    {% for estimation in estimations %}
                                                      <option value="{{ estimation.code }}">{{ estimation.code }}</option>
                                                    {% endfor %}
                                                    </select>
                                                </td>
                                                <td><input type="text" class="form-control" name="project_types[]" id=""></td>
                                                <td><input type="text" class="form-control" name="quantities[]" id=""></td>
                                                <td><input type="number" class="form-control _prices" name="prices[]" id=""></td>
                                                <td><button type="button" class="btn btn-outline-warning btn-md _delete-detail-btn"><i class="sub-icon fas fa-trash-alt"></i>削除</button></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="wrapper_button">
                                        <button type="button" class="btn-back btn btn-outline-warning btn-md _add-row"><i class="sub-icon fas fa-plus-circle-left"></i>追加</button>
                                    </div>
                                </div>
                                <p>■備考</p>
                                {% if invoice.colored_flag %}
                                    <textarea wrap="soft" placeholder="" name="description" id="_invoice-desctiption" style="color: red;">{{ invoice.description|default_if_none:"" }}</textarea>
                                {% else %}
                                    <textarea wrap="soft" placeholder="" name="description" id="_invoice-desctiption" style="color: black;">{{ invoice.description|default_if_none:"" }}</textarea>
                                {% endif %}
                                <input type="hidden" id="colored_flag" name="colored_flag" value="{{ invoice.colored_flag }}">
                                <button type="button" class="btn btn-outline-warning btn-md _invoice-colored-btn"><i class="sub-icon fas fa-pencil-alt"></i>色変更</button>
                            </div>
                        </form>
                        {% for estimation in estimations %}
                          <input type="hidden" id="_estimation_construction_name-{{ estimation.code }}" value="{{ estimation.construction_name }}">
                          <input type="hidden" id="_estimation_total-{{ estimation.code }}" value="{{ estimation.total }}">
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}
{% block script %}
    <script type="text/javascript" src="{% static 'js/common/validation.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/common/string-util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/invoices/detail.js' %}"></script>
{% endblock %}
