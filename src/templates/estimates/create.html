{% extends "base.html" %}
{% load static %}
{% block title %}IDEAL_ASP{% endblock %}
{% block style %}
    <!-- <link rel="stylesheet" type="text/css" href="{% static 'css/constructions/detail.css' %}"> -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/estimates/detail.css' %}">
{% endblock %}

{% load parse %}
{% load calc %}
{% load humanize %}

{% block content %}
<div class="wrapper">
    <div id="sideBar_wrapper" class="sideBar">
        {% include "side-bar.html" %}
    </div>
    <div class="row">
        <main class="col-md-12">
            <div class="p-6">
                {% include "documents-tab.html" %}
                <div class="tab-content">
                    <div id="tab_estimate" class="tab-pane active">
                        <form id="update-form" method="post">
                            {% csrf_token %}
                            <div id="_message-box" class="{{ alert_type }}">{{ alert_message }}</div>
                            <div id="e1">
                                <div class="wrapper_button">
                                    <button type="button" class="btn-back btn btn-outline-warning btn-md _go_back_btn"><i class="sub-icon fas fa-angle-double-left"></i>戻る</button>
                                    <button type="submit" class="btn-update btn btn-outline-warning btn-md _estimate-save-button" form="update-form" formaction="{% url 'estimates:commit' construction.id %}" formmethod="post"><i class="sub-icon fas fa-file-export"></i>保存</button>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form_area">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <tbody>
                                                    <tr>
                                                        <th>請求先顧客名</th>
                                                        <td>
                                                            <input type="text" class="form-control" name="client_name" value="{{ construction.client_name }}">
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>契約者名</th>
                                                        <td>
                                                            <input type="text" class="form-control" name="contractor_name" value="{{ construction.contractor_name }}">
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <tbody>
                                                    <tr>
                                                        <th>ステータス</th>
                                                        <td>
                                                            <select class="form-control" id="status" name="status">
                                                                {% for estimation_status in estimation_statuses %}
                                                                    {% if estimation_status.0 == '1' %}
                                                                        <option value="{{ estimation_status.0 }}" selected>{{ estimation_status.1 }}</option>
                                                                    {% else %}
                                                                        <option value="{{ estimation_status.0 }}">{{ estimation_status.1 }}</option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>見積提出日</th>
                                                        <td><input type="text" class="form-control" name="submission_date" value="" onfocus="type='date'"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>見積書番号</th>
                                                        <td></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <tbody>
                                                    <tr>
                                                        <th>工事番号</th>
                                                        <td>{{ construction.code }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>工事件名</th>
                                                        <td>
                                                            <input type="text" class="form-control" name="construction_name" value="{{ construction.name }}">
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>工事日数</th>
                                                        <td><input type="number" class="form-control" name="construction_days" value="{{ construction.planned_days }}"></td>
                                                    </tr>
                                                    <tr>
                                                        <th>日数単価</th>
                                                        <td></td>
                                                    </tr>
                                                    <tr>
                                                        <th>営業担当</th>
                                                        <td>
                                                            <select class="form-control" id="sales_user_name" name="sales_user_name" value="{{ construction.sales1_user.name }}">
                                                            {% for user in users %}
                                                                {% if user.name == construction.sales1_user.name %}
                                                                    <option value="{{ user.name }}" selected>{{ user.name }}</option>
                                                                {% else %}
                                                                    <option value="{{ user.name }}">{{ user.name }}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>積算担当</th>
                                                        <td>
                                                            <select class="form-control" id="accountant_user_name" name="accountant_user_name" value="{{ estimation.accountant_user_name }}">
                                                            {% for user in users %}
                                                                {% if user.name == construction.accountant_user.name %}
                                                                    <option value="{{ user.name }}" selected>{{ user.name }}</option>
                                                                {% else %}
                                                                    <option value="{{ user.name }}">{{ user.name }}</option>
                                                                {% endif %}
                                                            {% endfor %}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="row">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered text-nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th>作成者</th>
                                                            <th>作成日</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered text-nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th>修正者</th>
                                                            <th>修正日</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td></td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <table class="table table-striped">
                                                <tbody>
                                                    <tr>
                                                        <th>過去発行版</th>
                                                        <td></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6 offset-6">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>検印1</th>
                                                        <th>検印2</th>
                                                        <th>検印3</th>
                                                        <!--
                                                        <th>検印4</th>
                                                        -->
                                                        <th>作成者印</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <select class="form-control" id="stamp1_user_id" name="stamp1_user_id">
                                                                <option value="" disabled></option>
                                                                {% for user in users %}
                                                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control" id="stamp2_user_id" name="stamp2_user_id">
                                                                <option value="" disabled></option>
                                                                {% for user in users %}
                                                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control" id="stamp3_user_id" name="stamp3_user_id">
                                                                <option value="" disabled></option>
                                                                {% for user in users %}
                                                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <input type="hidden" name="stamp4_user_id" value="">
                                                        <!--
                                                        <td>
                                                            <select class="form-control" id="stamp4_user_id" name="stamp4_user_id">
                                                                <option value="" disabled></option>
                                                                {% for user in users %}
                                                                    <option value="{{ user.id }}">{{ user.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        -->
                                                        <td>
                                                            <select class="form-control" id="author_stamp_user_id" name="author_stamp_user_id">
                                                                <option value="" disabled></option>
                                                            {% for user in users %}
                                                                <option value="{{ user.id }}">{{ user.name }}</option>
                                                            {% endfor %}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <tr>
                                                    <th>摘要</th>
                                                    <td><textarea wrap="soft" name="summary" cols="30" rows="10"　maxlength="100" value="{{ estimation.summary }}">{{ estimation.summary }}</textarea></td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>内訳合計</th>
                                                        <th>消費税</th>
                                                        <th>合計金額</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <input type="hidden" id="tax_rate" name="tax_rate" value="{{ tax_rate }}">
                                                        <td><i id="estimate_total">0</i> 円</td>
                                                        <td><i id="estimate_tax">0</i> 円</td>
                                                        <td><i id="estimate_total_with_tax">0</i> 円</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th>原価合計</th>
                                                        <th>税別粗利</th>
                                                        <th>粗利率</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><i id="estimate_cost_total">0</i> 円</td>
                                                        <td><i id="estimate_gross_profit">0</i> 円</td>
                                                        <td><i id="estimate_gross_profit_rate">0</i> %</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="table-responsive">
                                        <table class="table table-bordered text-nowrap" id="_estimation-content">
                                            <thead>
                                                <tr>
                                                    <th rowspan="2">名称</th>
                                                    <th rowspan="2">仕様</th>
                                                    <th>数量</th>
                                                    <th>単位</th>
                                                    <th>単価</th>
                                                    <th>金額</th>
                                                    <th>粗利</th>
                                                    <th rowspan="2">備考</th>
                                                    <th rowspan="2">削除</th>
                                                </tr>
                                                <tr>
                                                    <th>原価数量</th>
                                                    <th>原価単位</th>
                                                    <th>原価単価</th>
                                                    <th>原価金額</th>
                                                    <th>粗利率</th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                    <div class="row">
                                      <div class="d-flex flex-row justify-content-end w-100">
                                          <button type="button" class="btn-back btn btn-outline-warning btn-md _estimate-mst-btn _estimation_template_search_btn"><i class="sub-icon fas fa-angle-double-left"></i>見積マスタ検索</button>
                                      </div>
                                    </div>
                                    <div id="_search-estimation-templates-modal" class="modal js-modal">
                                        <div class="modal__bg js-modal-close"></div>
                                        {% include "components/modal/search-estimation-templates-modal.html" %}
                                        <!--modal__inner-->
                                    </div><!--modal-->
                                </div>
                            </div>
                        </form>
                        <table>
                            <input type="hidden" id="_new_entry_id" value="0">
                            <tbody class="_estimation-entry _hidden_estimation-entry">
                                <tr>
                                    <input type="hidden" name="entry_delete_flgs" value="true">
                                    <input type="hidden" name="estimation_entry_ids" value="">
                                    <td rowspan="1" colspan="2"><input class="form-control" type="text" name="entry_names" value=""></td>
                                    <td><input class="form-control" type="number" name="entry_quantities" value=""></td>
                                    <td>
                                        <select class="form-control" name="entry_units" value="">
                                        {% for unit in units %}
                                            <option value="{{ unit.1 }}">{{ unit.1 }}</option>
                                        {% endfor %}
                                        </select>
                                    </td>
                                    <td><input class="form-control" type="text" name="entry_prices" value=""></td>
                                    <td><input class="form-control" type="text" disabled name="entry_totals" value=""></td>
                                    <td><input class="form-control" type="text" disabled name="entry_gross_profits" value=""></td>
                                    <td rowspan="2"><textarea wrap="hard" placeholder="" name="entry_descriptions" style="color: black;"></textarea></td>
                                    <td><button type="button" class="btn btn-outline-warning btn-md _delete-entry-btn" value=""><i class="sub-icon fas fa-trash-alt"></i>削除</button></td>
                                </tr>
                                <tr>
                                    <td rowspan="1" colspan="2"><input type="button" class="btn btn-outline-warning btn-md _accordion-btn" value="-"></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td><input class="form-control" type="text" disabled name="entry_cost_totals" value=""></td>
                                    <td><input class="form-control" type="text" disabled name="entry_gross_profit_rates" value=""></td>
                                    <td><button type="button" class="btn btn-outline-warning btn-md _estimate-colored-btn"><i class="sub-icon fas fa-pencil-alt"></i>色変更</button></td>
                                    <input type="hidden" name="entry_colored_flgs" value="0">
                                </tr>
                            </tbody>
                            <tbody class="_estimation-entry-detail _hidden_estimation-entry-detail">
                                <tr>
                                    <input type="hidden" name="detail_delete_flgs" value="true">
                                    <input type="hidden" name="entry_id_for_details" value="">
                                    <input type="hidden" name="entry_detail_ids" value="">
                                    <td rowspan="2"><input class="form-control" type="text" name="detail_names" value=""></td>
                                    <td rowspan="2"><input class="form-control" type="text" name="detail_project_types" value=""></td>
                                    <td><input class="form-control _detail_quantities" type="number" name="detail_quantities" value=""></td>
                                    <td>
                                        <select class="form-control" name="detail_units" value="">
                                        {% for unit in units %}
                                            <option value="{{ unit.1 }}">{{ unit.1 }}</option>
                                        {% endfor %}
                                        </select>
                                    </td>
                                    <td><input class="form-control _detail_prices" type="number" name="detail_prices" value=""></td>
                                    <td><input class="form-control _detail_totals" type="number" name="detail_totals" value=""></td>
                                    <td><input class="form-control" type="number" disabled name="detail_gross_profits" value=""></td>
                                    <td rowspan="2"><textarea wrap="hard" placeholder="" name="detail_descriptions" style="color: black;"></textarea></td>
                                    <td><button type="button" class="btn btn-outline-warning btn-md _delete-detail-btn"><i class="sub-icon fas fa-trash-alt"></i>削除</button></td>
                                </tr>
                                <tr>
                                    <td><input class="form-control _detail_nominal_quantities" type="number" name="detail_nominal_quantities" value=""></td>
                                    <td>
                                        <select class="form-control" name="detail_nominal_units" value="">
                                        {% for unit in units %}
                                            <option value="{{ unit.1 }}">{{ unit.1 }}</option>
                                        {% endfor %}
                                        </select>
                                    </td>
                                    <td><input class="form-control _detail_costs" type="number" name="detail_costs" value=""></td>
                                    <td><input class="form-control _detail_cost_totals" type="number" name="detail_cost_totals" value=""></td>
                                    <td><input class="form-control" type="text" disabled name="detail_gross_profit_rates" value=""></td>
                                    <td><button type="button" class="btn btn-outline-warning btn-md _estimate-colored-btn"><i class="sub-icon fas fa-pencil-alt"></i>色変更</button></td>
                                    <input type="hidden" name="detail_colored_flgs" value="0">
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}
{% block script %}
    <script type="text/javascript" src="{% static 'js/common/string-util.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/common/validation.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/estimates/detail.js' %}"></script>
{% endblock %}
