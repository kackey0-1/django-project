{% extends "base.html" %}
{% load static %}
{% block title %}IDEAL_ASP{% endblock %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/outsource_orders/constructions-detail.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/outsource_orders/detail.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/outsource_orders/common.css' %}">

{% endblock %}
{% block content %}
<div class="wrapper">
    <div id="sideBar_wrapper" class="sideBar">
        {% include "side-bar.html" %}
    </div>
    <div class="row">
        <main class="col-md-12">
            <div class="p-6">
                {% include "documents-tab.html" %}
                <div class="tab-content">
                    <div id="tab_outsource_orders" class="tab-pane active">
                        <form class="" method="post">
                            {% csrf_token %}
                            <div id="_message-box" class="{{ alert_type }}">{{ alert_message }}</div>
                            <div class="wrapper_button">
                                <button type="button" class="_go-back-btn btn btn-outline-warning btn-md">
                                    <i class="sub-icon fas fa-angle-double-left"></i>
                                    戻る
                                </button>
                                <button type="submit" class="_save-btn btn btn-outline-warning btn-md" formaction="{% url 'outsource_orders:commit' construction.id %}">
                                    <i class="sub-icon fas fa-file-export"></i>
                                    保存
                                </button>
                                <!-- <a href="">{# ボタンでjsの処理が走った後に遷移 #}
                                    <button type="button" class="_preview-btn btn btn-outline-warning btn-md"">
                                        <i class="sub-icon fas fa-search-plus"></i>
                                        プレビュー
                                    </button>
                                </a> -->
                                <!-- <a href="">{# ボタンでjsの処理が走った後に遷移 #}
                                    <button type="button" class="_delete-outsource-order-btn btn btn-outline-warning btn-md">
                                        <i class="sub-icon fas fa-trash-alt"></i>
                                        削除
                                    </button>
                                </a> -->
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>
                                                        発注先業者名<br>
                                                        <button class="_search-partner-company-btn" type="button" name="button"><i class="fas fa-search"></i>検索</button>
                                                    </th>
                                                    <td>
                                                        <input type="hidden" name="partner_company_id" class="_partner_company_id" value="{{ outsource_order.partner_company_id }}">
                                                        <input type="hidden" name="partner_company_name" class="_partner_company_name" value="{{ outsource_order.partner_company_name }}">
                                                        <div class="form-inline">
                                                            <p class="_partner-company-text" >{{ outsource_order.partner_company_name }}</p>
                                                            

                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>工事番号</th>
                                                    <td>{{ construction.code }}</td>
                                                </tr>
                                                <tr>
                                                    <th>現場名(工事件名)</th>
                                                    <td><input class="form-control" name="construction_name" value="{{ construction.name }}"></td>
                                                </tr>
                                                <tr>
                                                    <th>現場住所</th>
                                                    <td><input class="form-control" name="site_address" value="{{construction.site_address }}"></td>
                                                </tr>
                                                <tr>
                                                    <th>工事期間</th>
                                                    <td><input class="form-control" type="date" name="construction_start_date" value="{{ construction.start_date|date:'Y-m-d' }}">～<input class="form-control" type="date" name="construction_end_date" value="{{ construction.end_date|date:'Y-m-d' }}"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>発注日</th>
                                                    <td><input class="form-control" type="date" name="order_date" value="{{ now|date:'Y-m-d' }}"></td>
                                                </tr>
                                                <tr>
                                                    <th>商品発注番号</th>
                                                    <td>{{ outsource_order.code }}</td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>ステータス</th>
                                                    <td>
                                                      <select name="order_status" class="form-control">
                                                          <option value="0">未着</option>
                                                          <option value="1">差し戻し</option>
                                                          <option value="2">対応済み</option>
                                                          <option value="3">支払い</option>
                                                      </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>担当者</th>
                                                    <td>
                                                        <select name="charge_user_name" class="form-control">
                                                            {# 初期表示 #}
                                                            <option value="{{ construction.site1_user.name }}" _usertel="{{ construction.site1_user.tel }}">
                                                                {{ construction.site1_user.name }}
                                                            </option>
                                                            {% for user in users %}
                                                                <option value="{{ user.name }}" _usertel="{{ user.tel }}">
                                                                    {{ user.name }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>担当者電話番号</th>
                                                    <input type="hidden" name="charge_user_tel" value="{{ construction.site1_user.tel }}">
                                                    <td class="_tel-text">{{ construction.site1_user.tel }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="col-4">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>作成者</th>
                                                    <th>作成日</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>{{ outsource_order.created.name }}</td>
                                                    <td>{{ outsource_order.created_at|date:'Y-m-d' }}</td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-striped table-bordered text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>修正者</th>
                                                    <th>修正日</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>{{ outsource_order.updated.name }}</td>
                                                    <td>{{ outsource_order.updated_at|date:'Y-m-d' }}</td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>支払予定日</th>
                                                    <td><input disabled class="form-control" type="date" name="payment_expected_date" value=""></td>
                                                </tr>
                                                <tr>
                                                    <th>支払日</th>
                                                    <td><input class="form-control" type="date" name="payment_date" value="{{ now|date:'Y-m-d' }}"></td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <table class="table table-striped table-bordered text-nowrap">
                                            <tbody>
                                                <tr>
                                                    <th>備考</th>
                                                    <td><textarea name="description" wrap="soft"></textarea></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6"></div>
                                <table class="col-6 table table-striped table-bordered text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>作成者印</th>
                                            <th>検印1</th>
                                            <th>検印2</th>
                                            <th>検印3</th>
                                            <th>検印4</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <select name="author_stamp_user_id" class="form-control">
                                                    {% for user in users %}
                                                        <option value="{{ user.id }}"

                                                        >{{ user.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <select name="stamp1_user_id" class="form-control">
                                                    {% for user in users %}
                                                        <option value="{{ user.id }}"

                                                        >{{ user.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <select name="stamp2_user_id" class="form-control">
                                                    {% for user in users %}
                                                        <option value="{{ user.id }}"

                                                        >{{ user.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <select name="stamp3_user_id" class="form-control">
                                                    {% for user in users %}
                                                        <option value="{{ user.id }}"

                                                        >{{ user.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <select name="stamp4_user_id" class="form-control">
                                                    {% for user in users %}
                                                        <option value="{{ user.id }}"

                                                        >{{ user.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="row">
                                <div class="col-6"></div>
                                <table class="col-6 table table-striped table-bordered text-nowrap">
                                    <thead>
                                        <tr>
                                            <th>小計</th>
                                            <th>消費税</th>
                                            <th>合計金額</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><i class="_total">0</i> 円</td>
                                            <td><i class="_tax">0</i> 円</td>
                                            <td><i class="_total-with-tax">0</i> 円</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="row">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered text-nowrap _details-table">
                                        <thead>
                                            <tr>
                                                <th>工事内容</th>
                                                <th>数量</th>
                                                <th>単位</th>
                                                <th>単価</th>
                                                <th>金額(税抜)</th>
                                                <th>削除</th>
                                            </tr>
                                        </thead>

                                        <tbody id="_add-row-target">

                                            {% for outsource_detail in outsource_details %}
                                            <tr>
                                                <input type="hidden" name="delete_flgs[]" value="false">
                                                <input type="hidden" name="outsource_detail_ids[]" value="{{ outsource_detail.id }}">
                                                <td><input class="form-control" name="outsource_detail_construction_names[]" value="{{ outsource_detail.name }}"></td>
                                                <td><input class="form-control" name="outsource_detail_quantities[]" value="{{ outsource_detail.quantity }}"></td>
                                                <td><input class="form-control" name="outsource_detail_units[]" value="{{ outsource_detail.unit }}"></td>
                                                <td><input class="form-control" name="outsource_detail_unit_prices[]" value="{{ outsource_detail.unit_price }}"></td>
                                                <td><input class="form-control" name="outsource_detail_prices[]" value="{{ outsource_detail.price }}"></td>
                                                <td>
                                                    <button type="button" class="_delete-detail-btn btn btn-outline-warning btn-md">
                                                        <i class="sub-icon fas fa-trash-alt"></i>
                                                        削除
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}

                                            <tr class="_additional-row" style="display: none;">  {# jqのtoggle()でdisplay: noneが消える #}
                                                <input type="hidden" name="delete_flgs[]" value="true">
                                                <input type="hidden" name="outsource_detail_ids[]" value="">
                                                <td><input type="text" class="form-control" name="outsource_detail_construction_names[]" ></td>
                                                <td><input type="number" class="_calc-price-trigger form-control" name="outsource_detail_quantities[]" value=""></td>
                                                <td>
                                                    <select class="form-control" name="outsource_detail_units[]">
                                                        <option value=""></option>
                                                        {% for e in units_list %}
                                                            <option value="{{ e.0 }}">{{ e.1 }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td><input type="number" class="_calc-price-trigger form-control" name="outsource_detail_unit_prices[]" value=""></td>
                                                <td><input type="number" class="_calc-total-trigger form-control" name="outsource_detail_prices[]" value=""></td>
                                                <td>
                                                    <button type="button" class="_delete-detail-btn btn btn-outline-warning btn-md">
                                                        <i class="sub-icon fas fa-trash-alt"></i>
                                                        削除
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>

                                    </table>

                                </div>
                                <div class="d-flex flex-row justify-content-end w-100">
                                    <button class="_add-row-btn btn btn-outline-warning btn-md" type="button">
                                        追加
                                    </button>
                                </div>
                            </div>

                            <div class="row">
                                <p>■注意書き</p>
                                <textarea id="_note" name="note" wrap="soft"></textarea>
                                <!-- <button type="button" class="btn btn-outline-warning btn-md" value="_note" onclick="changeColor(this)">
                                    <i class="sub-icon fas fa-pencil-alt"></i>
                                    色変更
                                    <input type="hidden" name="colored_flag" value="false">
                                </button> -->
                            </div>
                        </form>
                        <input type="hidden" id="tax_rate" name="tax_rate" value="{{ tax_rate }}">
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="search-partner-company-modal" class="modal js-modal">
    <div class="modal__bg js-modal-close"></div>
    <div class="modal__content">
        {% include "components/modal/search-partner-company-modal.html" %}
        <a class="js-modal-close" href="">閉じる</a>
    </div><!--modal__inner-->
</div><!--modal-->

{% endblock %}
{% block script %}
<script type="text/javascript" src="{% static 'js/common/number-utils.js' %}"></script>
<script type="text/javascript" src="{% static 'js/common/string-util.js' %}"></script>
<script type="text/javascript" src="{% static 'js/outsource_orders/detail.js' %}"></script>
<script type="text/javascript" src="{% static 'js/outsource_orders/common.js' %}"></script>
{% endblock %}
